<?php

/**
 * profile actions.
 *
 * @package    CarSharing
 * @subpackage profile
 * @author     Your name here
 * @version    SVN: $Id: actions.class.php 23810 2009-11-12 11:07:44Z Kris.Wallsmith $
 */
class profileActions extends sfActions {

    /**
     * Executes index action
     *
     * @param sfRequest $request A request object
     */
    public function executeAjaxCalendar(sfWebRequest $request) {
        $this->setLayout(false);
        sfConfig::set('sf_web_debug', false);

        $start = $request->getParameter('start');
        $end = $request->getParameter('end');

        $avs = Doctrine_Core::getTable('Availability')
                ->createQuery('a')
                ->where("a.Car.User.id = ?", $this->getUser()->getAttribute("userid"))
                ->andWhere("
		(a.date_from >= '$start' and a.date_from <= '$end') or 
		(a.date_from <= '$start' and a.date_to >= '$end') or
		(a.date_to >= '$start' and a.date_to <= '$end') or
		(a.date_from <= '$end' and a.date_to = 0) "
                )
                ->execute();


        $aaData = Array();

        foreach ($avs as $a) {

            $i = 0;


            $dateTmp = date("Y-m-d", strtotime($a->getDateFrom()));
            if ($a->getDateTo() != 0)
                $dateTo = date("Y-m-d", strtotime($a->getDateTo()));
            else
                $dateTo = date("Y-m-d", strtotime($end));

            $startDate = date("Y-m-d", strtotime($start));
            $endDate = date("Y-m-d", strtotime($end));


            while ($dateTmp <= $dateTo) {


                $from = $dateTmp . " " . $a->getHourFrom();
                $to = $dateTmp . " " . $a->getHourTo();


                $dayArray = getdate(strtotime($dateTmp . " - 1 days"));

                if ($a->getDay() == null || $a->getDay() == $dayArray['wday']) {

                    if ($startDate <= $dateTmp && $endDate >= $dateTmp)
                        $aaData[] = array('id' => $a->getId(), 'start' => $from, 'end' => $to, 'title' => $a->getCar()->getModel() . " " . $a->getCar()->getModel()->getBrand());
                }

                $dateTmp = date("Y-m-d", strtotime($dateTmp . " + 1 days"));
            }
        }


        return $this->renderText(json_encode($aaData));
    }

    public function executeRatingsHistory(sfWebRequest $request) {

        if ($request->getParameter('id') == "")
            $this->user = Doctrine_Core::getTable('user')->find(array($this->getUser()->getAttribute("userid")));
        else
            $this->user = Doctrine_Core::getTable('user')->find(array($request->getParameter('id')));
        //$this->user->getMessegeTo();

        $this->ratingsCompleted = new Doctrine_Collection('rating');

        $reserves = $this->user->getReserves();
        $cars = $this->user->getCars();



        foreach ($cars as $c) {
            $carReserves = $c->getReserves();
            foreach ($carReserves as $cr) {
                if ($cr->getRating()->getId() != null)
                    if ($cr->getRating()->getUserOwnerOpnion() != "" && $cr->getRating()->getUserRenterOpnion() != "") {
                        $this->ratingsCompleted->add($cr->getRating());
                    }
            }
        }
    }

    //public function executeEdit(sfWebRequest $request)
    //{
    // $this->user = Doctrine_Core::getTable('user')->find(array($this->getUser()->getAttribute("userid")));
    //}






    public function executeGetAvInfo(sfWebRequest $request) {
        $this->setLayout(false);
        sfConfig::set('sf_web_debug', false);

        $id = $request->getParameter('id');

        $av = Doctrine_Core::getTable('Availability')
                ->createQuery('a')
                ->where("a.id = ?", $id)
                ->fetchOne();

        $aaData = Array();

        if ($av != null) {

            $datetime1 = $av->getDateTo();
            $datetime2 = $av->getDateFrom();


            if ($av->getDateTo() != 0) {

                $diff = abs(strtotime($datetime2) - strtotime($datetime1));
                $days = floor($diff / (60 * 60 * 24));
                if ($av->getDay() != null)
                    $week = $days / 7;
                else
                    $week = $days;
                $week = floor($week);
            }
            else {
                $week = "";
            }

            //if($week > floor($week))
            //$week = floor($week)+1;

            $aaData[] = array('id' => $av->getId(), 'start' => $av->getHourFrom(), 'end' => $av->getHourTo(), 'id' => $av->getId(), 'datefrom' => date("Y-m-d", strtotime($av->getDateFrom())), 'dateto' => date("Y-m-d", strtotime($av->getDateTo())), 'repeat' => $week, 'carid' => $av->getCar()->getId());
        }
        return $this->renderText(json_encode($aaData));
    }

    public function executeDeleteEvent(sfWebRequest $request) {
        $this->setLayout(false);
        sfConfig::set('sf_web_debug', false);

        $id = $request->getParameter('id');

        $av = Doctrine_Core::getTable('Availability')
                ->createQuery('a')
                ->where("a.id = ?", $id)
                ->fetchOne();

        $av->delete();

        $aaData[] = array('id' => null);
        return $this->renderText(json_encode($aaData));
    }

    public function executeSaveEvent(sfWebRequest $request) {

        $this->setLayout(false);
        sfConfig::set('sf_web_debug', false);

        $id = $request->getParameter('id');
        $date = date("Y-m-d", strtotime($request->getParameter('date')));
        $car = $request->getParameter('carid');
        $days = $request->getParameter('days');
        $start = $request->getParameter('start');
        $end = $request->getParameter('end');
        $repeat = $request->getParameter('repeat');
        $forever = $request->getParameter('forever');
        $dayofweek = $request->getParameter('dayofweek');

        if ($repeat == "all")
            $diff = (60 * 60 * 24) * ($days);
        else
            $diff = (60 * 60 * 24) * ($days * 7);

        $endDate = date("Y-m-d", (strtotime($date) + $diff));

        $av = Doctrine_Core::getTable('Availability')
                ->createQuery('a')
                ->where("a.id = ?", $id)
                ->fetchOne();

        $aaData = Array();

        if ($av == null) {
            $av = new Availability;
        }

        $av->setDateFrom($date);



        if ($repeat == "never")
            $av->setDateTo($date);
        else if ($forever == "checked")
            $av->setDateTo(0);
        else
            $av->setDateTo($endDate);

        if ($repeat == "1day")
            $av->setDay($dayofweek);

        $av->setHourFrom($start);
        $av->setHourTo($end);

        $car = Doctrine_Core::getTable('car')->find(array($car));
        $av->setCar($car);

        $av->save();

        $aaData[] = array('id' => $av->getId());
        return $this->renderText(json_encode($aaData));
    }

    public function executeJsCalendar(sfWebRequest $request) {
        $this->setLayout(false);
        sfConfig::set('sf_web_debug', false);
    }

    public function executeIndex(sfWebRequest $request) {

        $this->user = Doctrine_Core::getTable('user')->find(array($this->getUser()->getAttribute("userid")));
        $this->cars = $this->user->getCars();
    }

    public function executeProfile(sfWebRequest $request) {

        $this->user = Doctrine_Core::getTable('user')->find(array($this->getUser()->getAttribute("userid")));

        //$this->user->getMessegeTo();
    }

    public function executePublicprofile(sfWebRequest $request) {

        if ($request->getParameter('id') == "")
            $this->user = Doctrine_Core::getTable('user')->find(array($this->getUser()->getAttribute("userid")));
        else
            $this->user = Doctrine_Core::getTable('user')->find(array($request->getParameter('id')));
        //$this->user->getMessegeTo();
    }

    public function executeEdit(sfWebRequest $request) {
        $user = Doctrine_Core::getTable('user')->find(array($this->getUser()->getAttribute("userid")));



        $this->userRegion = $user->getRegion();

        $this->userComuna = $user->getComuna();

        $this->user = $user;


        $q = Doctrine_Query::create()
                ->select('c.*')
                ->from('Comunas c');

        $this->comunas = $q->fetchArray();

        $q = Doctrine_Query::create()
                ->select('r.*')
                ->from('Regiones r');

        $this->regiones = $q->fetchArray();
    }

    public function executeCars(sfWebRequest $request) {
        $this->user = Doctrine_Core::getTable('user')->find(array($this->getUser()->getAttribute("userid")));
        $this->cars = $this->user->getCars();
    }

    public function executeCar(sfWebRequest $request) {
        $this->car = Doctrine_Core::getTable('car')->find(array($request->getParameter('id')));
        $this->brand = Doctrine_Core::getTable('Brand')->createQuery('a')->execute();
        $this->country = Doctrine_Core::getTable('Country')->createQuery('a')->execute();
        $this->selectedBrand = $this->car->getModel()->getBrand();
        $this->selectedModel = $this->car->getModel();
        $this->selectedState = $this->car->getCity()->getState();
        $this->selectedCity = $this->car->getCity();
        $this->selectedCountry = $this->car->getCity()->getState()->getCountry();
    }

    private function getFileExtension($fileName) {
        $parts = explode(".", $fileName);
        return $parts[count($parts) - 1];
    }

    public function executeDoReserve(sfWebRequest $request) {

        $from = $request->getParameter('datefrom');
        $to = $request->getParameter('dateto');
		$carid = $request->getParameter('id');
		
        $hourdesde = "";
        $hourhasta = "";

        $desde = explode(" ", $from);
        $datedesde = $desde[0];
        $hourdesde = $desde[1];

        $hasta = explode(" ", $to);
        $datehasta = $hasta[0];
        $hourhasta = $hasta[1];

        if ($datedesde != "" && $datehasta != "") {

            //CORROBORAR SI SE SOLICITO ANTES PERO TIENE DURACION DURANTE EL PEDIDO
			
			$date = explode(' ', $date);
			$inverseDate = implode('-', array_reverse(explode('-', $date[0])));
			
            $startDate = date("Y-m-d H:i:s", strtotime($inverseDate . " " . $date[1] ));
            $endDate = date("Y-m-d H:i:s", strtotime($inverseDate . " + " . $duration . " hour"));
           
            $diff = strtotime($endDate) - strtotime($startDate);


            $duration = $diff / 60 / 60;

            if ($diff > 0) {

                $carid = $request->getParameter('id');

                $has_reserve = Doctrine_Core::getTable('Reserve')
                        ->createQuery('a')
                        ->where('((a.date <= ? and date_add(a.date, INTERVAL a.duration HOUR) > ?) or (a.date <= ? and date_add(a.date, INTERVAL a.duration HOUR) > ?)) and (a.Car.id = ?)', array($startDate, $startDate, $endDate, $endDate, $carid))
                        ->fetchArray();



                if (count($has_reserve) == 0) {

                    $reserve = new Reserve();
                    $reserve->setDuration($duration);
                    $reserve->setDate($startDate);

                    $user = Doctrine_Core::getTable('User')->find(array($this->getUser()->getAttribute("userid")));
                    $reserve->setUser($user);
                    $car = Doctrine_Core::getTable('Car')->find(array($carid));
                    $reserve->setCar($car);

                    if ($car->getUser()->getAutoconfirm()) {
                        $reserve->setConfirmed(true);
                    }
                    $reserve->save();

                    if ($car->getUser()->getAutoconfirm()) {
                        $this->sendConfirmEmail($reserve);
                    } else {
                        $this->sendReserveEmail($reserve);
                    }

                    if ($car->getUser()->getAutoconfirm()) {
                        $this->forward('profile', 'reserveConfirmed');
                    } else {
                        $this->redirect('profile/index');
                    }
                }
			

                $this->getUser()->setFlash('msg', 'Ya hay una reserva confirmada para ese horario');

                $this->getRequest()->setParameter('carid', $carid);
                
            } else {
                $this->getUser()->setFlash('msg', 'Fecha de entrega debe ser mayor a fecha inicial');
            }

            $this->forward('profile', 'reserve');
			
        } else {
            $this->redirect('profile/reserve?id=' . $request->getParameter('id'));
        }
    }

    public function executeReserveConfirmed(sfWebRequest $request) {
        $this->getUser()->setFlash('msg', 'Tu reserva ha sido confirmada. No olvides llevar tu tarjeta de crédito para retirar el auto.');
    }

    public function executeDoSaveCar(sfWebRequest $request) {
	
	
	
        $car = new Car();
        $car->setPricePerDay(floor($request->getParameter('priceday')));
        $car->setPricePerHour(floor($request->getParameter('pricehour')));
        $car->setYear($request->getParameter('year'));
        $car->setKm($request->getParameter('km'));
        $car->setAddress($request->getParameter('address'));
        $model = Doctrine_Core::getTable('Model')->find(array($request->getParameter('model')));
        $car->setModel($model);
        $city = Doctrine_Core::getTable('City')->find(array($request->getParameter('city')));
        $car->setCity($city);
        $car->setLng($request->getParameter('lng'));
        $car->setLat($request->getParameter('lat'));
        $user = Doctrine_Core::getTable('User')->find(array($this->getUser()->getAttribute("userid")));
        $car->setUser($user);
        $car->setDescription($request->getParameter('description'));
        $car->save();

        if ($request->getParameter('main') != null) {
            $q = Doctrine_Query::create()->from('Photo')
                    ->where('Photo.Type = ?', 'main')
                    ->where('Photo.Car.Id = ?', $car->getId());
            $main = $q->fetchOne();

            if (!$main) {
                $main = new Photo;
            }
            $main->setCar($car);
            $main->setPath($request->getParameter('main'));
            $main->setType('main');
            $main->save();
        }

        for ($i = 1; $i <= 5; $i++) {
            if ($request->getParameter('photo' . $i) != null) {
                $q = Doctrine_Query::create()->from('Photo')
                        ->where('Photo.Type = ?', 'photo' . $i)
                        ->andWhere('Photo.Car.Id = ?', $car->getId());
                $photo = $q->fetchOne();

                if (!$photo) {
                    $photo = new Photo;
                }
                $photo->setCar($car);
                $photo->setPath($request->getParameter('photo' . $i));
                $photo->setType('photo' . $i);
                $photo->save();
            }
        }

        for ($i = 1; $i <= 5; $i++) {
            if ($request->getParameter('desperfecto' . $i) != null) {
                $q = Doctrine_Query::create()->from('Photo')
                        ->where('Photo.Type = ?', 'desperfecto' . $i)
                        ->andWhere('Photo.Car.Id = ?', $car->getId());
                $photo = $q->fetchOne();

                if (!$photo) {
                    $photo = new Photo;
                }
                $photo->setCar($car);
                $photo->setPath($request->getParameter('desperfecto' . $i));
                $photo->setType('desperfecto' . $i);
                $photo->save();
            }
        }

		

        $av = new Availability;

        $av->setDateFrom( date("Y-m-d H:i:s"));
        $av->setDateTo(0);
        $av->setHourFrom("00:00:00");
        $av->setHourTo("23:59:00");
        $av->setCar($car);

        $av->save();


        $this->redirect('profile/index');
    }

    public function executeDoUpdateCar(sfWebRequest $request) {
        $car = Doctrine_Core::getTable('Car')->find(array($request->getParameter('id')));
        $car->setPricePerDay(floor($request->getParameter('priceday')));
        $car->setPricePerHour(floor($request->getParameter('pricehour')));
        $car->setYear($request->getParameter('year'));
        $car->setKm($request->getParameter('km'));
        $car->setAddress($request->getParameter('address'));
        $model = Doctrine_Core::getTable('Model')->find(array($request->getParameter('model')));
        $car->setModel($model);
        $city = Doctrine_Core::getTable('City')->find(array($request->getParameter('city')));
        $car->setCity($city);
        $car->setLng($request->getParameter('lng'));
        $car->setLat($request->getParameter('lat'));
        $car->setDescription($request->getParameter('description'));
        $car->save();


        if ($request->getParameter('main') != null) {
            $q = Doctrine_Query::create()->from('Photo')
                    ->where('Photo.Type = ?', 'main')
                    ->where('Photo.Car.Id = ?', $car->getId());
            $main = $q->fetchOne();

            if (!$main) {
                $main = new Photo;
            }
            $main->setCar($car);
            $main->setPath($request->getParameter('main'));
            $main->setType('main');
            $main->save();
        }

        for ($i = 1; $i <= 5; $i++) {
            if ($request->getParameter('photo' . $i) != null) {
                $q = Doctrine_Query::create()->from('Photo')
                        ->where('Photo.Type = ?', 'photo' . $i)
                        ->andWhere('Photo.Car.Id = ?', $car->getId());
                $photo = $q->fetchOne();

                if (!$photo) {
                    $photo = new Photo;
                }
                $photo->setCar($car);
                $photo->setPath($request->getParameter('photo' . $i));
                $photo->setType('photo' . $i);
                $photo->save();
            }
        }

        for ($i = 1; $i <= 5; $i++) {
            if ($request->getParameter('desperfecto' . $i) != null) {
                $q = Doctrine_Query::create()->from('Photo')
                        ->where('Photo.Type = ?', 'desperfecto' . $i)
                        ->andWhere('Photo.Car.Id = ?', $car->getId());
                $photo = $q->fetchOne();

                if (!$photo) {
                    $photo = new Photo;
                }
                $photo->setCar($car);
                $photo->setPath($request->getParameter('desperfecto' . $i));
                $photo->setType('desperfecto' . $i);
                $photo->save();
            }
        }


        $this->redirect('profile/index');
    }

    public function executeRatings(sfWebRequest $request) {
        $this->user = Doctrine_Core::getTable('user')->find(array($this->getUser()->getAttribute("userid")));
        $reserves = $this->user->getReserves();

        $this->ratings = new Doctrine_Collection('rating');
        foreach ($reserves as $r) {

            if ($r->getRating()->getId() != null) {
                if ($r->getRating()->getUserOwnerOpnion() != "" && $r->getRating()->getUserRenterOpnion() == "") {
                    $this->ratings->add($r->getRating());
                }
            }
        }


        $this->myRatings = new Doctrine_Collection('rating');
        $cars = $this->user->getCars();

        foreach ($cars as $c) {
            $carReserves = $c->getReserves();
            foreach ($carReserves as $cr) {
                if ($cr->getRating()->getId() != null)
                    if ($cr->getRating()->getUserOwnerOpnion() == "") {
                        $this->myRatings->add($cr->getRating());
                    }
            }
        }


        $this->ratingsCompleted = new Doctrine_Collection('rating');

        foreach ($cars as $c) {
            $carReserves = $c->getReserves();
            foreach ($carReserves as $cr) {
                if ($cr->getRating()->getId() != null)
                    if ($cr->getRating()->getUserOwnerOpnion() != "" && $cr->getRating()->getUserRenterOpnion() != "") {
                        $this->ratingsCompleted->add($cr->getRating());
                    }
            }
        }
    }

    public function executeConfirmMyRating(sfWebRequest $request) {


        $rating = Doctrine_Core::getTable('Rating')->find(array($request->getParameter('id')));
        $rating->setUserOwnerOpnion($request->getParameter('user_owner_opnion'));
        $rating->setIntime($request->getParameter('intime'));
        $rating->setQualified($request->getParameter('qualified'));
        $rating->setKm($request->getParameter('km'));
        //$rating->setConfirmed(true);

        $rating->save();

        $this->redirect('profile/ratings');
    }

    public function executeConfirmTheyRating(sfWebRequest $request) {

        $rating = Doctrine_Core::getTable('Rating')->find(array($request->getParameter('id')));
        $rating->setUserOwnerOpnion($request->getParameter('user_owner_opnion'));
        $rating->setIntime($request->getParameter('intime'));
        $rating->setQualified($request->getParameter('qualified'));
        $rating->setKm($request->getParameter('km'));
        $rating->setCleanSatisfied($request->getParameter('satisfied'));

        //$rating->setConfirmed(true);

        $rating->save();

        $this->redirect('profile/ratings');
    }

    public function executeTransactions(sfWebRequest $request) {

        $this->user = Doctrine_Core::getTable('user')->find(array($this->getUser()->getAttribute("userid")));

        //GetPositiveRatings()

        $q = Doctrine_Query::create()
                ->select('r.id , ca.id idcar , mo.name model, 
	  br.name brand, ca.year year, 
	  ca.address address, ci.name city, 
	  st.name state, co.name country, 
	  owner.firstname firstname, owner.lastname lastname,
	  r.date date, owner.id userid'
                )
                ->from('Reserve r')
                ->innerJoin('r.Car ca')
                ->innerJoin('ca.Model mo')
                ->innerJoin('ca.User owner')
                ->innerJoin('r.User user')
                ->innerJoin('mo.Brand br')
                ->innerJoin('ca.City ci')
                ->innerJoin('ci.State st')
                ->innerJoin('st.Country co')
                ->where('user.id = ?', $this->getUser()->getAttribute("userid"))
                ->andWhere('r.confirmed = ?', true)
                ->andWhere('r.complete = ?', false);
        $this->rentings = $q->execute();


        $this->transactions = Doctrine_Core::getTable('Transaction')
                ->createQuery('a')
                ->where('a.User.Id = ?', array($this->user->getId()))
                ->andWhere('a.completed != ?', true)
                ->execute();

        $this->paidTransactions = Doctrine_Core::getTable('Transaction')
                ->createQuery('a')
                ->innerJoin('a.Reserve re')
                ->innerJoin('re.Car ca')
                ->where('ca.User.Id = ?', array($this->user->getId()))
                ->andWhere('a.completed = ?', true)
                ->execute();


        //	$this->transactions = $this->user->getTransactions();

        $this->reportTypes = Doctrine_Core::getTable('ReportType')->createQuery('a')->execute();

        $this->reports = new Doctrine_Collection('Report');
        $this->currentReports = new Doctrine_Collection('Report');

        foreach ($this->user->getCars() as $car) {

            foreach ($car->getReserves() as $reserve) {


                foreach ($reserve->getReports() as $r) {

                    if ($r->getRenterComment() != "" && $r->getOwnerComment() == "") {
                        $this->currentReports->add($r);
                    }

                    if ($r->getRenterComment() != "" && $r->getOwnerComment() != "") {
                        $this->reports->add($r);
                    }
                }
            }
        }
    }

    public function executeMessages(sfWebRequest $request) {
        /*
          echo $this->messages = $q->getSqlQuery();

          SELECT *
          FROM Message
          WHERE id IN (SELECT MAX(id) FROM Message GROUP BY conversation)
         */

        $q = Doctrine_Query::create()->from('message')
                ->where('message.user_to > ?', $this->getUser()->getAttribute("userid"))
                //->andWhere('message.user_from > ?', 2)
                ->andwhere('message.id IN (SELECT MAX(id) FROM Message GROUP BY conversation)');
        $this->messages = $q->fetchArray();
    }

    public function executeReserve(sfWebRequest $request) {
        $this->activeToReseve = true;

        $reserves = Doctrine_Core::getTable('Reserve')
                ->createQuery('a')
                ->where('a.complete != ?', true)
                ->andWhere('a.user_id = ?', $this->getUser()->getAttribute("userid"))
                ->andWhere('a.confirmed = 0')
                ->fetchArray();

        if (count($reserves) >= 5) {
            $this->activeToReseve = false;
        }


        if ($this->getRequest()->getParameter('carid') != null)
            $carid = $this->getRequest()->getParameter('carid');
        else
            $carid = $request->getParameter('id');

        $this->car = Doctrine_Core::getTable('car')->find(array($carid));
        $this->user = $this->car->getUser();
        $this->getUser()->setAttribute('lastview', $request->getReferer());
    }

    public function executeAddCar(sfWebRequest $request) {
        $this->car = new Car();
        //Doctrine_Core::getTable('Car')->find(array($request->getParameter('id')));
        $this->brand = Doctrine_Core::getTable('Brand')->createQuery('a')->execute();
        $this->country = Doctrine_Core::getTable('Country')->createQuery('a')->execute();
        $this->selectedBrand = new Brand();
        $this->selectedModel = new Model();
        $this->selectedState = new State();
        $this->selectedCity = new City();
        $this->selectedCountry = new Country();
    }

    public function executeAddAvailability(sfWebRequest $request) {

        $this->user = Doctrine_Core::getTable('user')->find(array($this->getUser()->getAttribute("userid")));
        $this->cars = $this->user->getCars();
    }

    /* public function executeRentings(sfWebRequest $request)
      {

      $this->car = Doctrine_Core::getTable('car')->find(array($request->getParameter('id')));

      }
     */

    public function executeRental(sfWebRequest $request) {

        $this->car = Doctrine_Core::getTable('car')->find(array($request->getParameter('id')));






        $q = Doctrine_Query::create()
                ->select('r.id , ca.id idcar , mo.name model, 
	  br.name brand, ca.year year, 
	  ca.address address, ci.name city, 
	  st.name state, co.name country, 
	  user.firstname firstname, user.lastname lastname,
	  r.date date, ADDDATE(r.date, INTERVAL r.duration HOUR) fechafin'
                )
                ->from('Reserve r')
                ->innerJoin('r.Car ca')
                ->innerJoin('ca.Model mo')
                ->innerJoin('ca.User owner')
                ->innerJoin('r.User user')
                ->innerJoin('mo.Brand br')
                ->innerJoin('ca.City ci')
                ->innerJoin('ci.State st')
                ->innerJoin('st.Country co')
                ->where('owner.id = ?', $this->getUser()->getAttribute("userid"))
                ->andWhere('r.confirmed = ?', true)
                ->andWhere('r.complete = ?', false);
        //->andWhere('r.date > ?',  date('Y-m-d H:i:s.u'));
        $this->inprogress = $q->execute();



        $q = Doctrine_Query::create()
                ->select('r.id , ca.id idcar , mo.name model, 
	  br.name brand, ca.year year, 
	  ca.address address, ci.name city, 
	  st.name state, co.name country, 
	  user.firstname firstname, user.lastname lastname,
	  r.date date '
                )
                ->from('Reserve r')
                ->innerJoin('r.Car ca')
                ->innerJoin('ca.Model mo')
                ->innerJoin('ca.User owner')
                ->innerJoin('r.User user')
                ->innerJoin('mo.Brand br')
                ->innerJoin('ca.City ci')
                ->innerJoin('ci.State st')
                ->innerJoin('st.Country co')
                ->where('owner.id = ?', $this->getUser()->getAttribute("userid"))
                ->andWhere('r.confirmed = ?', false)
                ->andWhere('r.complete = ?', false);
        $this->toconfirm = $q->execute();


        $q = Doctrine_Query::create()
                ->select('r.id , ca.id idcar , mo.name model, 
	  br.name brand, ca.year year, 
	  ca.address address, ci.name city, 
	  st.name state, co.name country, 
	  user.firstname firstname, user.lastname lastname,
	  r.date date'
                )
                ->from('Reserve r')
                ->innerJoin('r.Car ca')
                ->innerJoin('ca.Model mo')
                ->innerJoin('ca.User owner')
                ->innerJoin('r.User user')
                ->innerJoin('mo.Brand br')
                ->innerJoin('ca.City ci')
                ->innerJoin('ci.State st')
                ->innerJoin('st.Country co')
                ->where('owner.id = ?', $this->getUser()->getAttribute("userid"))
                ->andWhere('r.confirmed = ?', true)
                ->andWhere('r.complete = ?', false);
        $this->cars = $q->execute();
    }

    public function getMes($month) {
        
    }

    public function sendConfirmEmail($reserve) {

        $to = $reserve->getUser()->getEmail();
        $subject = "Reserva Confirmada";

        // compose headers
        $headers = "From: \"Arriendas Reservas\" <no-reply@arriendas.cl>\n";
        $headers .= "Content-type: text/html\n";
        $headers .= "X-Mailer: PHP/" . phpversion() . "\n";

        ereg("([0-9]{2,4})-([0-9]{1,2})-([0-9]{1,2}) ([0-9]{1,2}):([0-9]{1,2}):([0-9]{1,2})", $reserve->getDate(), $datetime);

        $date_from = strftime("%A %e de %B", mktime($datetime[4], $datetime[5], 0, $datetime[2], $datetime[3], $datetime[1]));
        $hour_from = date("H:s", mktime($datetime[4], $datetime[5], 0, $datetime[2], $datetime[3], $datetime[1]));

        $date_to = strftime("%A %e de %B", mktime($datetime[4] + $reserve->getDuration(), $datetime[5], 0, $datetime[2], $datetime[3], $datetime[1]));
        $hour_to = date("H:s", mktime($datetime[4] + $reserve->getDuration(), $datetime[5], 0, $datetime[2], $datetime[3], $datetime[1]));
        $url = $_SERVER['SERVER_NAME'] . $this->getController()->genUrl('profile/publicprofile?id=' . $reserve->getCar()->getUser()->getId());

        $mail = 'Su reserva para el auto ' . $reserve->getCar()->getModel()->getBrand()->getName() . ' ' . $reserve->getCar()->getModel()->getName() .
                ' del usuario ' . $reserve->getCar()->getUser()->getFirstName() . ' ' . $reserve->getCar()->getUser()->getLastName() . ' ha sido confirmada.<br/><br/>
	
	Debes retirar el auto el d&iacute;a ' . $date_from . ' a las ' . $hour_from . ' y devolverlo el d&iacute;a ' . $date_to . ' a las ' . $hour_to . '.<br/><br/>
	
	No olvide llevar su tarjeta de cr&eacute;dito para retirarlo.  <br/><br/>
	
	Para ver el perfil del due&ntilde;o del auto ' .
                $reserve->getCar()->getUser()->getFirstname() . ' ' . $reserve->getCar()->getUser()->getLastname() . ' has click <a href="' . $url . '">aqui</a>. <br/><br/>
	
	El equipo de Arriendas.cl';

        // send email
        mail($to, $subject, $mail, $headers);

        //MAIL DUEÑO

        $to = $reserve->getCar()->getUser()->getEmail();
        $subject = "Has recibido una reserva!";

        // compose headers
        $headers = "From: \"Arriendas Reservas\" <no-reply@arriendas.cl>\n";
        $headers .= "Content-type: text/html\n";
        $headers .= "X-Mailer: PHP/" . phpversion() . "\n";

        ereg("([0-9]{2,4})-([0-9]{1,2})-([0-9]{1,2}) ([0-9]{1,2}):([0-9]{1,2}):([0-9]{1,2})", $reserve->getDate(), $datetime);

        $date_from = strftime("%A %e de %B", mktime($datetime[4], $datetime[5], 0, $datetime[2], $datetime[3], $datetime[1]));
        $hour_from = date("H:s", mktime($datetime[4], $datetime[5], 0, $datetime[2], $datetime[3], $datetime[1]));

        $date_to = strftime("%A %e de %B", mktime($datetime[4] + $reserve->getDuration(), $datetime[5], 0, $datetime[2], $datetime[3], $datetime[1]));
        $hour_to = date("H:s", mktime($datetime[4] + $reserve->getDuration(), $datetime[5], 0, $datetime[2], $datetime[3], $datetime[1]));
        $url = $_SERVER['SERVER_NAME'] . $this->getController()->genUrl('profile/publicprofile?id=' . $reserve->getUser()->getId());

        $mail = 'Has recibido una reserva por tu ' .
                $reserve->getCar()->getModel()->getBrand()->getName() . ' ' . $reserve->getCar()->getModel()->getName() .
                ' desde el d&iacute;a ' . $date_from . ' a las ' . $hour_from .
                ' hasta el d&iacute;a ' . $date_to . ' a las ' . $hour_to . ' cuando el usuario ' . $reserve->getUser()->getFirstname() . ' ' . $reserve->getUser()->getLastname() . ' devuelva el auto. <br/><br/>
	
	Para ver el perfil del usuario ' .
                $reserve->getUser()->getFirstname() . ' ' . $reserve->getUser()->getLastname() . ' has click <a href="' . $url . '">aqui</a>. <br/><br/>
	
	El equipo de Arriendas.cl';

        // send email
        mail($to, $subject, $mail, $headers);
    }

    public function sendReserveEmail($reserve) {

        $to = $reserve->getUser()->getEmail();
        $subject = 'Has realizado una reserva!';

        // compose headers
        $headers = "From: \"Arriendas Reservas\" <no-reply@arriendas.cl>\n";
        $headers .= "Content-type: text/html\n";
        $headers .= "X-Mailer: PHP/" . phpversion() . "\n";

        $mail = 'Se ha solicitado una reserva para el auto ' . $reserve->getCar()->getModel()->getBrand()->getName() . ' ' . $reserve->getCar()->getModel()->getName() .
                ' del usuario ' . $reserve->getCar()->getUser()->getFirstName() . ' ' . $reserve->getCar()->getUser()->getLastName() . '.
	
	Gracias
	Arriendas.cl';

        // send email
        mail($to, $subject, $mail, $headers);

        //MAIL DUEÑO

        $to = $reserve->getCar()->getUser()->getEmail();
        $subject = 'Has recibido un pedido de reserva!';

        // compose headers
        $headers = "From: \"Arriendas Reservas\" <no-reply@arriendas.cl>\n";
        $headers .= "Content-type: text/html\n";
        $headers .= "X-Mailer: PHP/" . phpversion() . "\n";

        ereg("([0-9]{2,4})-([0-9]{1,2})-([0-9]{1,2}) ([0-9]{1,2}):([0-9]{1,2}):([0-9]{1,2})", $reserve->getDate(), $datetime);

        $date_from = strftime("%A %e de %B", mktime($datetime[4], $datetime[5], 0, $datetime[2], $datetime[3], $datetime[1]));
        $hour_from = date("H:s", mktime($datetime[4], $datetime[5], 0, $datetime[2], $datetime[3], $datetime[1]));

        $date_to = strftime("%A %e de %B", mktime($datetime[4] + $reserve->getDuration(), $datetime[5], 0, $datetime[2], $datetime[3], $datetime[1]));
        $hour_to = date("H:s", mktime($datetime[4] + $reserve->getDuration(), $datetime[5], 0, $datetime[2], $datetime[3], $datetime[1]));
        $url = $_SERVER['SERVER_NAME'] . $this->getController()->genUrl('profile/publicprofile?id=' . $reserve->getUser()->getId());

        $mail = 'Has recibido un pedido de reserva por tu ' .
                $reserve->getCar()->getModel()->getBrand()->getName() . ' ' . $reserve->getCar()->getModel()->getName() .
                ' desde el día ' . $date_from . ' a las ' . $hour_from .
                ' hasta el día ' . $date_to . ' a las ' . $hour_to . ' cuando hayas devuelto el auto. <br/><br/>
	
	Para ver el perfil del usuario ' .
                $reserve->getUser()->getFirstname() . ' ' . $reserve->getUser()->getLastname() . ' has click <a href="' . $url . '">aqui</a>. <br/><br/>
	
	El equipo de Arriendas.cl';

        // send email
        mail($to, $subject, $mail, $headers);
    }

    public function sendEndReserveEmail($reserve) {

        $to = $reserve->getUser()->getEmail();
        $subject = 'Finalizacion de Reserva';

        // compose headers
        $headers = "From: \"Arriendas Reservas\" <no-reply@arriendas.cl>\n";
        $headers .= "Content-type: text/html\n";
        $headers .= "X-Mailer: PHP/" . phpversion() . "\n";

        $mail = 'Ha finalizado la reseva para el auto ' . $reserve->getCar()->getModel()->getBrand()->getName() . ' ' . $reserve->getCar()->getModel()->getName() .
                ' del usuario ' . $reserve->getCar()->getUser()->getFirstName() . ' ' . $reserve->getCar()->getUser()->getLastName() . ' que usted realizo.
	
	Gracias
	Arriendas.cl';

        // send email
        mail($to, $subject, $mail, $headers);

        //MAIL ALQUILANDO
        //MAIL DUEÑO

        $to = $reserve->getCar()->getUser()->getEmail();
        $subject = 'Finalizacion de Reserva';

        // compose headers
        $headers = "From: \"Arriendas Reservas\" <no-reply@arriendas.cl>\n";
        $headers .= "Content-type: text/html\n";
        $headers .= "X-Mailer: PHP/" . phpversion() . "\n";

        $mail = 'Ha solicitado la reserva de su auto ' . $reserve->getCar()->getModel()->getBrand()->getName() . ' ' . $reserve->getCar()->getModel()->getName() .
                ' alquilado por el usuario ' . $reserve->getUser()->getFirstName() . ' ' . $reserve->getUser()->getLastName() . '.
	
	Gracias
	Arriendas.cl';

        // send email
        mail($to, $subject, $mail, $headers);
    }

    public function executeConfirmReserve(sfWebRequest $request) {

        $reserve = Doctrine_Core::getTable('Reserve')->find(array($request->getParameter('id')));
        $reserve->setConfirmed(true);
        $reserve->save();

        $transaction = new Transaction();
        $carString = $reserve->getCar()->getModel()->getName() . " " . $reserve->getCar()->getModel()->getBrand()->getName();
        $transaction->setCar($carString);
        $transaction->setPrice(($reserve->getCar()->getPricePerHour()) * ($reserve->getDuration()));
        $transaction->setUser($reserve->getUser());
        $transaction->setDate(date("Y-m-d H:i:s"));
        $transactionType = Doctrine_Core::getTable('TransactionType')->find(1);
        $transaction->setTransactionType($transactionType);
        $transaction->setReserve($reserve);
        $transaction->setCompleted(false);
        $transaction->save();


        $startDate = date("Y-m-d H:i:s", strtotime($reserve->getDate()));
        $endDate = date("Y-m-d H:i:s", strtotime($reserve->getDate() . " + " . $reserve->getDuration() . " hour"));
        $userid = $reserve->getUser()->getId();

        $reserve = Doctrine_Core::getTable('Reserve')
                ->createQuery('a')
                ->where('((a.date <= ? and date_add(a.date, INTERVAL a.duration HOUR) > ?) or (a.date <= ? and date_add(a.date, INTERVAL a.duration HOUR) > ?)) and (a.User.id = ? and a.confirmed = false)', array($startDate, $startDate, $endDate, $endDate, $userid))
                ->execute();

        foreach ($reserve as $r) {
            $r->delete();
        }


        //$this->sendConfirmEmail($reserve);
        $this->redirect('profile/rental');
    }

    public function executeCompleteReserve(sfWebRequest $request) {
        $rating = new Rating();
        $rating->save();

        $reserve = Doctrine_Core::getTable('Reserve')->find(array($request->getParameter('id')));
        $reserve->setComplete(true);
        $reserve->setRating($rating);
        $reserve->save();

        $this->sendEndReserveEmail($reserve);

        $this->redirect('profile/rental');
    }

    public function executeUpload() {
        $fileName = $this->getRequest()->getFileName('file');

        $this->getRequest()->moveFile('file', sfConfig::get('sf_upload_dir') . '/' . $fileName);

        $this->redirect('media/show?filename=' . $fileName);
    }

    public function executeDoSaveAvailability(sfWebRequest $request) {

        $availibility = new Availability();
        $availibility->setDateFrom($request->getParameter('date_from'));
        $availibility->setDateTo($request->getParameter('date_to'));
        $availibility->setHourFrom($request->getParameter('hour_from'));
        $availibility->setHourTo($request->getParameter('hour_to'));
        $availibility->setDay($request->getParameter('day'));
        $car = Doctrine_Core::getTable('Car')->find(array($request->getParameter('car')));
        $availibility->setCar($car);
        $availibility->save();

        $this->redirect('profile/index');
    }

    public function executeDoUpdateProfile(sfWebRequest $request) {

        try {

            $profile = Doctrine_Core::getTable('User')->find($this->getUser()->getAttribute('userid'));
            $profile->setFirstname($request->getParameter('firstname'));
            $profile->setLastname($request->getParameter('lastname'));
            $profile->setEmail($request->getParameter('email'));
            $profile->setRegion($request->getParameter('region'));
            $profile->setComuna($request->getParameter('comunas'));
            $profile->setBirthdate($request->getParameter('birth'));
            if ($request->getParameter('password') == $request->getParameter('passwordAgain'))
                $profile->setPassword(md5($request->getParameter('password')));
            $profile->getTelephone($request->getParameter('telephone'));
            if ($request->getParameter('main') != NULL)
                $profile->setPictureFile($request->getParameter('main'));
            if ($request->getParameter('licence') != NULL)
                $profile->setDriverLicenseFile($request->getParameter('licence'));
            $profile->save();
            $this->getUser()->setAttribute('picture_url', $profile->getFileName());
        } catch (Exception $e) {
            echo $e->getMessage();
        }


        $this->redirect('profile/index');
    }

    public function executeGetModel(sfWebRequest $request) {

        sfConfig::set('sf_web_debug', false);
        $_output;

        /* Asegurar que la solicitud sea AJAX */
        //if (!$request->isXmlHttpRequest())
        //return $this->renderText(json_encode(array('error'=>'S�lo respondo consultas v�a AJAX.')));

        if ($request->getParameter('id')) {

            $brand = Doctrine_Core::getTable('Brand')->find(array($request->getParameter('id')));

            foreach ($brand->getModels() as $p) {
                $_output[] = array("optionValue" => $p->getId(), "optionDisplay" => $p->getName());
            }

            return $this->renderText(json_encode($_output));
        }
        return $this->renderText(json_encode(array('error' => 'Faltan par�metros para realizar la consulta')));
    }

    public function executeGetState(sfWebRequest $request) {

        sfConfig::set('sf_web_debug', false);
        $_output;

        /* Asegurar que la solicitud sea AJAX */
        //if (!$request->isXmlHttpRequest())
        //return $this->renderText(json_encode(array('error'=>'S�lo respondo consultas v�a AJAX.')));

        if ($request->getParameter('id')) {

            $country = Doctrine_Core::getTable('Country')->find(array($request->getParameter('id')));

            foreach ($country->getStates() as $p) {
                $_output[] = array("optionValue" => $p->getId(), "optionDisplay" => $p->getName());
            }

            return $this->renderText(json_encode($_output));
        }
        return $this->renderText(json_encode(array('error' => 'Faltan par&aacute;metros para realizar la consulta')));
    }

    public function executeGetCity(sfWebRequest $request) {

        sfConfig::set('sf_web_debug', false);
        $_output;

        /* Asegurar que la solicitud sea AJAX */
        //if (!$request->isXmlHttpRequest())
        //return $this->renderText(json_encode(array('error'=>'S�lo respondo consultas v�a AJAX.')));

        if ($request->getParameter('id')) {

            $state = Doctrine_Core::getTable('State')->find(array($request->getParameter('id')));

            foreach ($state->getCities() as $p) {
                $_output[] = array("optionValue" => $p->getId(), "optionDisplay" => $p->getName());
            }

            return $this->renderText(json_encode($_output));
        }
        return $this->renderText(json_encode(array('error' => 'Faltan par�metros para realizar la consulta')));
    }

    public function executeUploadPhoto(sfWebRequest $request) {

        $valid_formats = array("jpg", "png", "gif", "bmp", "jpeg");

        if (isset($_POST) and $_SERVER['REQUEST_METHOD'] == "POST") {
            $name = $_FILES[$request->getParameter('file')]['name'];
            $size = $_FILES[$request->getParameter('file')]['size'];
            if (strlen($name)) {
                list($txt, $ext) = explode(".", $name);
                if (in_array($ext, $valid_formats)) {
                    if ($size < (1024 * 1024)) { // Image size max 1 MB
                        $userid = $this->getUser()->getAttribute("userid");
                        $actual_image_name = time() . $userid . "." . $ext;

                        $uploadDir = sfConfig::get("sf_web_dir");
                        $path = $uploadDir . '/images/cars/';
                        $fileName = $actual_image_name . "." . $ext;

                        $tmp = $_FILES[$request->getParameter('file')]['tmp_name'];
                        if (move_uploaded_file($tmp, $path . $actual_image_name)) {
                            sfContext::getInstance()->getConfiguration()->loadHelpers("Asset");

                            echo "<input type='hidden' name='" . $request->getParameter('photo') . "' value='" . $path . $actual_image_name . "'/>";
                            echo "<img src='" . image_path("cars/" . $actual_image_name) . "' class='preview' height='" . $request->getParameter('height') . "' width='" . $request->getParameter('width') . "' />";
                        }
                        else
                            echo "failed";
                    }
                    else
                        echo "Image file size max 1 MB";
                }
                else
                    echo "Invalid file format..";
            }
            else
                echo "Please select image..!";
            exit;
        }



        /* 	foreach ($request->getFiles() as $fileName) {
          $fileSize = $fileName['size'];
          $fileType = $fileName['type'];
          $extesion = getFileExtension($fileName['name']);


          if(!is_dir($csv))
          mkdir($csv, 0777);
          move_uploaded_file($fileName['tmp_name'], "$folder/$fileName");
          }
         */
    }
     public function executeDetalleReserva(sfWebRequest $request) {
        if ($this->getUser()->isAuthenticated()) {

            $id = $request->getParameter('id');

            try {

                $q = Doctrine_Query::create()
                        ->select('r.id , ca.id idcar , mo.name model, 
	  br.name brand, ca.year year, 
          ca.price_per_hour pricehour, ca.price_per_day priceday,
	  ca.address address, ci.name city, 
	  st.name state, co.name country, 
	  user.firstname firstname, user.lastname lastname,
	  r.date date, r.duration'
                        )
                        ->from('Reserve r')
                        ->innerJoin('r.Car ca')
                        ->innerJoin('ca.Model mo')
                        ->innerJoin('ca.User owner')
                        ->innerJoin('r.User user')
                        ->innerJoin('mo.Brand br')
                        ->innerJoin('ca.City ci')
                        ->innerJoin('ci.State st')
                        ->innerJoin('st.Country co')
                        ->where('r.user_id = ?', $this->getUser()->getAttribute("userid"))
                        ->andWhere('r.confirmed = ?', 1)
                        ->andWhere('r.complete = ?', 0)
                        ->andWhere('r.id = ?', $id);
                //->andWhere('r.date > ?',  date('Y-m-d H:i:s.u'));

                $this->misreservas = $q->execute();
                //echo $q->getSqlQuery();die;
            } catch (Exception $e) {
                echo $e->getMessage();
            }
        } else {
            $this->getUser()->setAttribute('lastview', $request->getUri());
            $this->forward('main', 'login');
        }
    }
    
    public function executeMyReserves(sfWebRequest $request) {

        if ($this->getUser()->isAuthenticated()) {

            $this->id = $request->getParameter('id');
            $this->v = $request->getParameter('v');

            try {

                $q = Doctrine_Query::create()
                        ->select('r.id , ca.id idcar , mo.name model, 
	  br.name brand, ca.year year, 
          ca.price_per_hour pricehour, ca.price_per_day priceday,
	  ca.address address, ci.name city, 
	  st.name state, co.name country, 
	  user.firstname firstname, user.lastname lastname,
	  r.date date, r.duration'
                        )
                        ->from('Reserve r')
                        ->innerJoin('r.Car ca')
                        ->innerJoin('ca.Model mo')
                        ->innerJoin('ca.User owner')
                        ->innerJoin('r.User user')
                        ->innerJoin('mo.Brand br')
                        ->innerJoin('ca.City ci')
                        ->innerJoin('ci.State st')
                        ->innerJoin('st.Country co')
                        ->where('r.user_id = ?', $this->getUser()->getAttribute("userid"))
                        ->andWhere('r.confirmed = ?', 1)
                        ->andWhere('r.complete = ?', 0);
                //->andWhere('r.date > ?',  date('Y-m-d H:i:s.u'));

                $this->misreservas = $q->execute();
                //echo $q->getSqlQuery();die;
            } catch (Exception $e) {
                echo $e->getMessage();
            }
        } else {
            $this->getUser()->setAttribute('lastview', $request->getUri());
            $this->forward('main', 'login');
        }
    }
    public function executeDeleteReserve(sfWebRequest $request) {

        $this->setLayout(false);

        $idReserva = $request->getParameter('idReserva');
        
        
        
        if (!is_nan($idReserva) && !is_null($idReserva)) {
            try {
                                
                $q = Doctrine_Query::create()
                        ->delete()
                        ->from('Transaction t')
                        ->andWhere('t.reserve_id = ?', $idReserva)
                        ->execute();
                
                $q = Doctrine_Query::create()
                        ->delete()
                        ->from('Reserve')
                        ->andWhere('user_id = ?', $this->getUser()->getAttribute('userid'))
                        ->andWhere('id = ?', $idReserva)
                        ->execute();
            } catch (Exception $e) {
                echo $e->getMessage();die;
            }
        }
        if ($request->getMethod() != 'POST') {
            $this->forward('profile', 'myReserves');
        } else {
            echo 'ok';
        }
        return sfView::NONE;
    }
    
    public function executeEditReserve(sfWebRequest $request) {

        $idReserva = $request->getParameter('idReserva');
        $datedesde = $request->getParameter('fechainicio');
        $datehasta = $request->getParameter('fechafin');
        $hourdesde = "";
        $hourhasta = "";

        $desde = explode(" ", $datedesde);
        $datedesde = $desde[0];
        $hourdesde = $desde[1];

        $hasta = explode(" ", $datehasta);
        $datehasta = $hasta[0];
        $hourhasta = $hasta[1];

        //echo $datehasta.'\n'.$hourhasta;die;
        //print_r($request);die;
        //$duration = $request->getParameter('duration');
        //if($date != ""  && $duration != "")
        if ($datedesde != "" && $datehasta != "" && $hourdesde != "" && $hourhasta != "" &&
                preg_match('/^(([0-1][0-9])|([2][0-3])):([0-5][0-9]):([0-5][0-9])$/', $hourdesde) &&
                preg_match('/^(([0-1][0-9])|([2][0-3])):([0-5][0-9]):([0-5][0-9])$/', $hourhasta) &&
                preg_match('/^\d{4}\-\d{1,2}\-\d{1,2}$/', $datedesde) &&
                preg_match('/^\d{4}\-\d{1,2}\-\d{1,2}$/', $datehasta)) {

            //CORROBORAR SI SE SOLICITO ANTES PERO TIENE DURACION DURANTE EL PEDIDO

            $startDate = date("Y-m-d H:i:s", strtotime($datedesde . " " . $hourdesde));
            $endDate = date("Y-m-d H:i:s", strtotime($datehasta . " " . $hourhasta));

            $diff = strtotime($endDate) - strtotime($startDate);

            $duration = $diff / 60 / 60;


            $carid = $request->getParameter('carid');


            $has_reserve = Doctrine_Core::getTable('Reserve')
                    ->createQuery('a')
                    ->where('((a.date <= ? and date_add(a.date, INTERVAL a.duration HOUR) > ?) or (a.date <= ? and date_add(a.date, INTERVAL a.duration HOUR) > ?)) and (a.Car.id = ?)', array($startDate, $startDate, $endDate, $endDate, $carid))
                    ->andWhere('a.id != ?', $idReserva)
                    ->fetchArray();



            if (count($has_reserve) == 0) {

                if ($diff > 0) {

                    try {

                        Doctrine_Query::create()
                                ->update('Reserve r')
                                ->set('r.date', '?', $startDate)
                                ->set('r.duration', '?', $duration)
                                ->where('r.id = ?', $idReserva)
                                ->execute();
                        echo '0';
                    } catch (Exception $e) {
                        echo 'Error al modificar su reserva'; //.' error: '.$e->getMessage()
                    }
                } else {
                    echo 'Fecha de retiro debe ser mayor a fecha de entrega';
                }
            } else {
                echo 'Ya hay una reserva confirmada para ese horario';
            }
        } else {
            echo 'Por favor ingrese fechas con formato YYYY-MM-DD HH:MM';
        }
        return sfView::NONE;
    }

}
