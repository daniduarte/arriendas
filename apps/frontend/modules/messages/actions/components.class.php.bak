<?php

class messagesComponents extends sfComponents {

    public function executeLinkMessage() {
        $this->actual = $this->getUser()->getAttribute("userid");
    }

    public function executeAlerts() {
        $this->news = Doctrine_Core::getTable("Message")->countNewsByUserId($this->getUser()->getAttribute("userid"));
        $this->pends = Doctrine_Core::getTable("Transaction")->countIncompleteByUser($this->getUser()->getAttribute("userid"));
        $this->rents = Doctrine_Core::getTable("Reserve")->countInProgressByUser($this->getUser()->getAttribute("userid"));
    }

    public function executeGlobe() {
        $this->trans = Doctrine_Core::getTable("Transaction")->findByUser($this->getUser()->getAttribute("userid"), 5);
    }

    public function executeMail() {
        $this->mensaje = Doctrine_Core::getTable("Message")->lastMessageByUserId($this->getUser()->getAttribute("userid"), 5);
    }

    public function executeCar() {
        //$this->cars = Doctrine_Core::getTable("Reserve")->getInProgressByUser($this->getUser()->getAttribute("userid"));
        $q = Doctrine_Query::create()
                ->select('r.id , ca.id idcar , mo.name model,
	  br.name brand, ca.year year,
	  ca.address address, ci.name city,
	  st.name state, co.name country,
	  user.firstname firstname, user.lastname lastname,
	  r.date date'
                )
                ->from('Reserve r')
                ->innerJoin('r.Car ca')
                ->innerJoin('ca.Model mo')
                ->innerJoin('ca.User owner')
                ->innerJoin('r.User user')
                ->innerJoin('mo.Brand br')
                ->innerJoin('ca.City ci')
                ->innerJoin('ci.State st')
                ->innerJoin('st.Country co')
                ->where('owner.id = ?', $this->getUser()->getAttribute("userid"))
                ->andWhere('r.confirmed = ?', true)
                ->andWhere('r.complete = ?', false)
                ->andWhere('r.owner_confirmed = ?', false);
        $this->cars =  $q->execute();
    }

    public function executeVerify() {

        $user = Doctrine_Core::getTable('User')->find(array($this->getUser()->getAttribute("userid")));
        $data[] = array(false, "Scan de documento");
        $data[] = array(($user->getDriverLicenseFile() != null), "Scan de licencia");
        $data[] = array(($user->getConfirmed()), "Email confirmado");
        $data[] = array(($user->getConfirmedFb()), "Facebook confirmado");
        $data[] = array(($user->getConfirmedSms()), "Telefono confirmado");
        $data[] = array(($user->getPaypalId() != null), "Medios de pagos");
        $this->userdata = $data;
    }

}

?>
